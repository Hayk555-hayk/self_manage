<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Progress & Motivation Tracker</title>
    <link rel="stylesheet" href="assets/motivation.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>üî• Progress & Motivation Tracker</h2>
        <p id="user-email"></p>
        <button id="logout-btn" class="logout-btn">Log Out</button>
        <h5><a href="profile.html">Goals</a></h5>
        <h5><a href="finance_manager.html">Finance Manager</a></h5>


        <section class="log-input-section">
            <h3>Log Task Completion</h3>
            
            <form id="progress-form" class="input-form">
                <select id="goal-select" required>
                    <option value="" disabled selected>Select Main Goal (Loading...)</option>
                    </select>

                <select id="score-select" required>
                    <option value="" disabled selected>Select Result</option>
                    <option value="10">üèÜ Excellent Completion (+10)</option>
                    <option value="5">‚úÖ Routine Done (+5)</option>
                    <option value="0">‚ö™ Neutral / Not Applicable (0)</option>
                    <option value="-5">üü° Poor Effort (-5)</option>
                    <option value="-40">‚ùå Failed / Not Done (-40)</option>
                </select>
                
                <input type="text" id="description-input" placeholder="Optional notes (e.g., 'Finished Chapter 5')" maxlength="100">
                <button type="submit">Log Score</button>
            </form>
        </section>

        <section class="summary-section">
            <h3>Current Motivation Score</h3>
            <div id="current-score" class="score-card">
                Loading...
            </div>
            
            <h3>Score Dynamics Over Time</h3>
            <div class="chart-container">
                <canvas id="scoreChart"></canvas>
            </div>
        </section>
        
        <section class="log-history-section">
            <h3>Activity Log</h3>
            <ul id="activity-log">
                </ul>
        </section>

    </div>

    <script type="module">
        import { auth } from "./js/firebase-config.js";
        import { logout } from "./js/auth.js";
        import { initMotivationController, logScore } from "./js/motivationController.js";
        
        const qs = (id) => document.getElementById(id);

        auth.onAuthStateChanged(user => {
            if (user) {
                qs("user-email").textContent = "Logged in as: " + user.email;
                initMotivationController(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
            } else {
                window.location.href = "login.html"; 
            }
        });

        qs("logout-btn").onclick = () => logout();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
        qs("progress-form").onsubmit = async (e) => {
            e.preventDefault();
            
            const goalSelect = qs("goal-select");
            const goalId = goalSelect.value;
            const goalTitle = goalSelect.options[goalSelect.selectedIndex].text.replace(/\s*\(.*\)/, ''); // –û—á–∏—â–∞–µ–º –æ—Ç ID –≤ —Å–∫–æ–±–∫–∞—Ö
            const score = parseInt(qs("score-select").value);
            const description = qs("description-input").value.trim();
            
            if (goalId && score !== null) {
                try {
                    await logScore(goalId, goalTitle, score, description);
                    // –°–±—Ä–æ—Å –ø–æ–ª–µ–π –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ (–∫—Ä–æ–º–µ —Ü–µ–ª–∏)
                    qs("score-select").value = '';
                    qs("description-input").value = '';
                } catch (error) {
                    console.error("Error logging score:", error.message);
                }
            } else {
                console.warn("Please select a Goal and a Score.");
            }
        };
    </script>
</body>
</html>