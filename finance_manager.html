<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Financial Dashboard</title>
    <link rel="stylesheet" href="assets/finance.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>üí∞ Financial Dashboard</h2>
        <p id="user-email"></p>
        <button id="logout-btn" class="logout-btn">Log Out</button>
        <h5><a href="profile.html">Goals</a></h5>
        <h5><a href="motivation_tracker.html">Motivation Tracker</a></h5>

        <section class="data-input-section">
            <h3>Add Transaction or Income</h3>
            
            <form id="transaction-form" class="input-form">
                <select id="transaction-type" required>
                    <option value="" disabled selected>Select Type</option>
                    <option value="Income">Income (Salary, Bonus, etc.)</option>
                    <option value="Expense">Expense (Food, bills, etc.)</option>
                    <option value="Savings_Deposit">Savings Deposit</option>
                    <option value="Credit_Payment">Credit Payment</option>
                    <option value="Debt_Added">New Debt/Loan</option>
                </select>
                <input type="number" id="amount-input" placeholder="Amount (AMD)" required min="0">
                <input type="text" id="description-input" placeholder="Description (e.g., 'Groceries', 'Client Payout')">
                <button type="submit">Save Transaction</button>
            </form>
        </section>

        <section class="summary-section">
            <h3>Current Financial Metrics</h3>
            <div id="summary-metrics" class="metrics">
                </div>
        </section>

        <section class="charts-section">
            <h3>Visual Breakdown</h3>

            <div class="chart-controls">
                <label for="time-filter">Show Data for:</label>
                <select id="time-filter">
                    <option value="day">Current Day</option>
                    <option value="week">Last 7 Days</option>
                    <option value="month" selected>Last 30 Days</option>
                    <option value="year">Last Year</option>
                </select>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h4>1. Income vs Expense (Bar Chart)</h4>
                    <canvas id="chartIncomeExpense"></canvas>
                </div>

                <div class="chart-card">
                    <h4>2. Net Worth & Savings (Doughnut Chart)</h4>
                    <canvas id="chartNetWorth"></canvas>
                </div>
                
                <div class="chart-card wide">
                    <h4>3. Financial Flow Over Time</h4>
                    <canvas id="chartTimeFlow"></canvas>
                </div>
            </div>
        </section>

    </div>

    <script type="module">
        import { auth } from "./js/firebase-config.js";
        import { logout } from "./js/auth.js";
        import { initFinanceController, addTransaction } from "./js/financeController.js";
        
        const qs = (id) => document.getElementById(id);

        auth.onAuthStateChanged(user => {
            if (user) {
                qs("user-email").textContent = "Logged in as: " + user.email;
                initFinanceController(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
            } else {
                window.location.href = "login.html"; 
            }
        });

        qs("logout-btn").onclick = () => logout();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
        qs("transaction-form").onsubmit = async (e) => {
            e.preventDefault();
            
            const type = qs("transaction-type").value;
            const amount = parseFloat(qs("amount-input").value);
            const description = qs("description-input").value.trim() || type;
            
            if (type && amount > 0) {
                try {
                    await addTransaction(type, amount, description);
                    qs("amount-input").value = '';
                    qs("description-input").value = '';
                } catch (error) {
                    console.error("Error saving data:", error.message);
                }
            } else {
                console.warn("Please select a data type and enter a valid amount.");
            }
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ (–¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ 3)
        qs("time-filter").onchange = () => {
             // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –æ–±–Ω–æ–≤–∏—Ç –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏
             initFinanceController(); 
        };
    </script>
</body>
</html>