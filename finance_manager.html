<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Financial Dashboard V5 - Debt Tracker</title>
    <link rel="stylesheet" href="assets/finance.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>üí∞ Financial Dashboard V5</h2>
        <p id="user-email"></p>
        <button id="logout-btn" class="logout-btn">Log Out</button>
        <h5><a href="profile.html">Goals</a></h5>
        <h5><a href="motivation_tracker.html">Motivation Tracker</a></h5>

        <section class="settings-section">
            <h3>‚öôÔ∏è Fixed Financial Settings (Monthly)</h3>
            <form id="settings-form" class="input-form">
                <input type="text" id="fixed-salary" placeholder="Monthly Salary (AMD)" required>
                <input type="text" id="fixed-debt" placeholder="Monthly Credit Payments (AMD)" required>
                <input type="text" id="fixed-savings" placeholder="Fixed Monthly Savings (AMD)" required> 
                <button type="submit">Update Fixed Settings</button>
            </form>
            <div id="current-settings" class="metrics">
                </div>
        </section>
        
        <hr>

        <section class="debt-tracker-section">
            <h3>üí≥ Total Debt Repayment Tracker</h3>
            
            <div id="total-debt-status" class="metrics">
                </div>
            
            <form id="total-debt-init-form" class="input-form">
                <input type="text" id="initial-debt-amount" placeholder="Set Total Initial Debt (AMD)" required>
                <button type="submit" class="init-btn">Set Total Debt</button>
            </form>
            
            <h4>Log Debt Repayment:</h4>
            <form id="debt-repayment-form" class="input-form">
                <input type="text" id="repayment-amount" placeholder="Repayment Amount (AMD)" required min="0">
                <button type="submit" class="repay-btn">Log Repayment</button>
            </form>
        </section>
        
        <hr>

        <section class="data-input-section">
            <h3>Add Variable Transaction (Expense or Bonus)</h3>
            
            <form id="transaction-form" class="input-form">
                <select id="transaction-type" required>
                    <option value="" disabled selected>Select Type</option>
                    <option value="Expense">Expense (Food, Bills, etc.)</option>
                    <option value="Bonus">Bonus (Prizes, Side Income, Refunds)</option>
                </select>
                <input type="text" id="amount-input" placeholder="Amount (AMD)" required min="0"> 
                <input type="text" id="description-input" placeholder="Description (e.g., 'Groceries', 'Client Payout')">
                <button type="submit">Save Transaction</button>
            </form>
        </section>
        
        <hr>

        <section class="summary-section">
            <h3>Current Financial Metrics</h3>
            <div id="summary-metrics" class="metrics">
                </div>
        </section>

        <section class="charts-section">
            <h3>Visual Breakdown (Doughnut Charts)</h3>

            <div class="chart-controls">
                <h4>Custom Date Range Filter (Affects Variable Data Only):</h4>
                <div class="input-form">
                    <label for="start-date">Start Date:</label>
                    <input type="date" id="start-date">
                    
                    <label for="end-date">End Date:</label>
                    <input type="date" id="end-date">
                    
                    <button id="apply-filter-btn" type="button">Apply Filter</button>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h4>1. Fixed Income vs Fixed Obligations</h4>
                    <canvas id="chartFixedObligations"></canvas>
                </div>

                <div class="chart-card">
                    <h4>2. Fixed Flow Breakdown (S/D/S)</h4>
                    <canvas id="chartFixedBreakdown"></canvas>
                </div>
                
                <div class="chart-card">
                    <h4>3. Total Cash Flow (Income vs Obligations)</h4>
                    <canvas id="chartTotalFlow"></canvas>
                </div>

                <div class="chart-card">
                    <h4>4. Variable Flow Breakdown (Bonus vs Expense)</h4>
                    <canvas id="chartVariableBreakdown"></canvas>
                </div>

                <div class="chart-card wide">
                    <h4>5. Total Debt Repayment Progress</h4>
                    <canvas id="chartDebtTracker"></canvas>
                </div>
            </div>
        </section>

        <hr>

        <section class="history-section">
            <h3>Transaction History (Variable)</h3>
            <ul id="transaction-history-list">
                </ul>
        </section>

    </div>

    <script type="module">
        import { auth } from "./js/firebase-config.js";
        import { logout } from "./js/auth.js";
        import { 
            initFinanceController, 
            addTransaction, 
            updateFixedSettings,
            loadTransactionsForUser,
            setInitialTotalDebt,
            addDebtRepaymentLog,
            deleteTransaction,
            updateTransaction 
        } from "./js/financeController.js";
        
        const qs = (id) => document.getElementById(id);

        const loadFilteredData = () => {
            const startDate = qs('start-date').value;
            const endDate = qs('end-date').value;
            loadTransactionsForUser(startDate, endDate);
        };

        auth.onAuthStateChanged(user => {
            if (user) {
                qs("user-email").textContent = "Logged in as: " + user.email;
                initFinanceController(); 
            } else {
                window.location.href = "login.html"; 
            }
        });

        qs("logout-btn").onclick = () => logout();
        qs("apply-filter-btn").onclick = () => loadFilteredData();

        // 1. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–• –ù–ê–°–¢–†–û–ï–ö
        qs("settings-form").onsubmit = async (e) => {
            e.preventDefault();
            const salary = parseFloat(qs("fixed-salary").value.replace(',', '.'));
            const debt = parseFloat(qs("fixed-debt").value.replace(',', '.'));
            const savings = parseFloat(qs("fixed-savings").value.replace(',', '.'));
            
            if (!isNaN(salary) && !isNaN(debt) && !isNaN(savings)) {
                try {
                    await updateFixedSettings(salary, debt, savings); 
                } catch (error) {
                    console.error("Error saving fixed settings:", error.message);
                }
            } else {
                alert("Please enter valid numbers for all fixed settings.");
            }
        };

        // 2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ü–ï–†–ï–ú–ï–ù–ù–´–• –¢–†–ê–ù–ó–ê–ö–¶–ò–ô
        qs("transaction-form").onsubmit = async (e) => {
            e.preventDefault();
            const type = qs("transaction-type").value;
            const amount = parseFloat(qs("amount-input").value); 
            const description = qs("description-input").value.trim() || type;
            if (type && amount > 0) {
                try {
                    await addTransaction(type, amount, description);
                    qs("amount-input").value = '';
                    qs("description-input").value = '';
                } catch (error) {
                    console.error("Error saving data:", error.message);
                }
            } else {
                alert("Please select a data type and enter a valid positive amount.");
            }
        };
        
        // 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ò—Å—Ö–æ–¥–Ω–æ–≥–æ –î–æ–ª–≥–∞
        qs("total-debt-init-form").onsubmit = async (e) => {
            e.preventDefault();
            const initialAmount = parseFloat(qs("initial-debt-amount").value.replace(',', '.'));
            if (!isNaN(initialAmount) && initialAmount >= 0) {
                await setInitialTotalDebt(initialAmount);
                qs("initial-debt-amount").value = '';
            } else {
                alert("Please enter a valid non-negative amount for the total debt.");
            }
        };

        // 4. –û–±—Ä–∞–±–æ—Ç—á–∏–∫: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ü–æ–≥–∞—à–µ–Ω–∏—è
        qs("debt-repayment-form").onsubmit = async (e) => {
            e.preventDefault();
            const repaymentAmount = parseFloat(qs("repayment-amount").value.replace(',', '.'));
            if (!isNaN(repaymentAmount) && repaymentAmount > 0) {
                await addDebtRepaymentLog(repaymentAmount);
                qs("repayment-amount").value = '';
            } else {
                alert("Please enter a valid positive amount for the repayment.");
            }
        };
        
        // CRUD (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
        window.deleteTransaction = deleteTransaction;
        window.updateTransaction = updateTransaction;
        window.editTransaction = (id, currentType, currentAmount, currentDescription) => {
            const newAmountStr = prompt(`Enter new amount for ${currentDescription}:`, currentAmount);
            if (newAmountStr === null) return; 
            const newAmount = parseFloat(newAmountStr.replace(',', '.'));
            if (isNaN(newAmount) || newAmount < 0) {
                alert("Invalid amount entered. Please enter a positive number.");
                return;
            }
            const newDescription = prompt(`Enter new description for ${currentType}:`, currentDescription) || currentDescription;
            updateTransaction(id, newAmount, newDescription);
        }

    </script>
</body>
</html>