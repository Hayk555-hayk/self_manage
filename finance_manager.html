<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Financial Dashboard</title>
    <link rel="stylesheet" href="assets/finance.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>üí∞ Financial Dashboard V2</h2>
        <p id="user-email"></p>
        <button id="logout-btn" class="logout-btn">Log Out</button>
        <h5><a href="profile.html">Goals</a></h5>
        <h5><a href="motivation_tracker.html">Motivation Tracker</a></h5>

        <section class="settings-section">
            <h3>‚öôÔ∏è Fixed Financial Settings</h3>
            <form id="settings-form" class="input-form">
                <input type="text" id="fixed-salary" placeholder="Monthly Salary (USD)" required>
                <input type="text" id="fixed-debt" placeholder="Monthly Credit Payments (USD)" required>
                <button type="submit">Update Fixed Settings</button>
            </form>
            <div id="current-settings" class="metrics">
                </div>
        </section>

        <section class="data-input-section">
            <h3>Add Variable Transaction (Expense or Bonus)</h3>
            
            <form id="transaction-form" class="input-form">
                <select id="transaction-type" required>
                    <option value="" disabled selected>Select Type</option>
                    <option value="Expense">Expense (Food, Bills, etc.)</option>
                    <option value="Bonus">Bonus (Prizes, Side Income, Refunds)</option>
                    <option value="Savings_Deposit">Savings Deposit</option>
                </select>
                <input type="text" id="amount-input" placeholder="Amount (USD)" required min="0"> 
                <input type="text" id="description-input" placeholder="Description (e.g., 'Groceries', 'Client Payout')">
                <button type="submit">Save Transaction</button>
            </form>
        </section>

        <section class="summary-section">
            <h3>Current Financial Metrics</h3>
            <div id="summary-metrics" class="metrics">
                </div>
        </section>

        <section class="charts-section">
            <h3>Visual Breakdown</h3>

            <div class="chart-controls">
                <label for="time-filter">Show Data for Variable Flow:</label>
                <select id="time-filter">
                    <option value="day">Current Day</option>
                    <option value="week">Last 7 Days</option>
                    <option value="month" selected>Last 30 Days</option>
                    <option value="year">Last Year</option>
                </select>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h4>1. Total Cash Flow (Fixed vs Variable)</h4>
                    <canvas id="chartTotalFlow"></canvas>
                </div>

                <div class="chart-card">
                    <h4>2. Variable Flow Breakdown (Bonus vs Expense)</h4>
                    <canvas id="chartVariableBreakdown"></canvas>
                </div>
                
                <div class="chart-card wide">
                    <h4>3. Variable Flow Over Time</h4>
                    <canvas id="chartTimeFlow"></canvas>
                </div>
            </div>
        </section>

        <section class="history-section">
            <h3>Transaction History (Variable)</h3>
            <ul id="transaction-history-list">
                </ul>
        </section>

    </div>

    <script type="module">
        import { auth } from "./js/firebase-config.js";
        import { logout } from "./js/auth.js";
        import { 
            initFinanceController, 
            addTransaction, 
            updateFixedSettings 
        } from "./js/financeController.js";
        
        const qs = (id) => document.getElementById(id);

        auth.onAuthStateChanged(user => {
            if (user) {
                qs("user-email").textContent = "Logged in as: " + user.email;
                initFinanceController(); 
            } else {
                window.location.href = "login.html"; 
            }
        });

        qs("logout-btn").onclick = () => logout();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–• –ù–ê–°–¢–†–û–ï–ö
        qs("settings-form").onsubmit = async (e) => {
            e.preventDefault();
            const salary = parseFloat(qs("fixed-salary").value.replace(',', '.'));
            const debt = parseFloat(qs("fixed-debt").value.replace(',', '.'));
            
            if (!isNaN(salary) && !isNaN(debt)) {
                try {
                    await updateFixedSettings(salary, debt);
                } catch (error) {
                    console.error("Error saving fixed settings:", error.message);
                }
            } else {
                alert("Please enter valid numbers for Salary and Debt.");
            }
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –ü–ï–†–ï–ú–ï–ù–ù–´–• –¢–†–ê–ù–ó–ê–ö–¶–ò–ô
        qs("transaction-form").onsubmit = async (e) => {
            e.preventDefault();
            
            const type = qs("transaction-type").value;
            const amount = parseFloat(qs("amount-input").value); 
            const description = qs("description-input").value.trim() || type;
            
            if (type && amount > 0) {
                try {
                    await addTransaction(type, amount, description);
                    qs("amount-input").value = '';
                    qs("description-input").value = '';
                } catch (error) {
                    console.error("Error saving data:", error.message);
                }
            } else {
                alert("Please select a data type and enter a valid positive amount.");
            }
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ 
        qs("time-filter").onchange = () => {
             initFinanceController(); 
        };
    </script>
</body>
</html>